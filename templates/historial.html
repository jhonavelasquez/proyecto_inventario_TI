{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_historial.css') }}">
{% endblock %}

{% block content %}

<h1 class="block-effect" style="--td:0.3s">
    <div class="block-reveal" style="--bc: #2b3034; --d: 0.5s">Historial</div>
</h1>
{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
        <li class="breadcrumb-item active" aria-current="page">Historial</li>
    </ol>
</nav>
{% endblock %}
<div class="card mb-4">
    <div class="card-body">
        <form method="get" action="{{ url_for('historial') }}" id="filtro-form" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="categoria" class="form-label">Selecciona una Categoría</label>
                <select id="categoria" class="form-select" name="categoria" aria-label="Selecciona una Categoría">
                    <option value="">Todas las Categorías</option>
                    {% for categoria in categorias %}
                    <option value="{{ categoria['id_categoria'] }}" {% if
                        request.args.get('categoria')==categoria['id_categoria'] %} selected {% endif %}>
                        {{ categoria['nombre_categoria'] }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="date-from" class="form-label">Desde</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                    <input id="date-from" class="form-control" type="date" name="date-from" aria-label="date-from"
                        value="{{ request.args.get('date-from', '') }}">
                </div>
            </div>
            <div class="col-md-3">
                <label for="date-to" class="form-label">Hasta</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                    <input id="date-to" class="form-control" type="date" name="date-to" aria-label="date-to"
                        value="{{ request.args.get('date-to', '') }}">
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" type="submit">
                    <i class="bi bi-search me-2"></i>Buscar
                </button>

                <a class="btn btn-secondary w-100 mt-2" type="button" href="{{ url_for('historial') }}">
                    <i class="bi bi-x-circle me-2"></i>Limpiar
                </a>
            </div>
        </form>
    </div>
</div>

{% if categoria_nombre %}
<h2 class="h4 mb-4">Categoría: {{ categoria_nombre['nombre_categoria'] }}</h2>
{% endif %}

{% if historial_data %}
<div class="list-group mb-4">
    {% for registro in historial_data %}
    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-1">{{ registro['usuario_historial'] }}</h5>
            <p class="mb-1">{{ registro['descripcion'] }}</p>
        </div>
        <small class="text-muted">{{ registro['fecha'] }}</small>
    </div>
    {% endfor %}
</div>

<nav aria-label="Paginación del historial">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('historial', page=page-1, categoria=request.args.get('categoria')) }}"
                aria-label="Anterior">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% endif %}

        {% if start_page > 1 %}
        <li class="page-item">
            <a class="page-link"
                href="{{ url_for('historial', page=1, categoria=request.args.get('categoria')) }}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endif %}

        {% for p in range(start_page, end_page + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('historial', page=p, categoria=request.args.get('categoria')) }}">{{ p
                }}</a>
        </li>
        {% endfor %}

        {% if end_page < total_pages %} {% if end_page < total_pages - 1 %} <li class="page-item disabled"><span
                class="page-link">...</span></li>
            {% endif %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('historial', page=total_pages, categoria=request.args.get('categoria')) }}">{{
                    total_pages }}</a>
            </li>
            {% endif %}

            {% if page < total_pages %} <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('historial', page=page+1, categoria=request.args.get('categoria')) }}"
                    aria-label="Siguiente">
                    <span aria-hidden="true">&raquo;</span>
                </a>
                </li>
                {% endif %}
    </ul>
</nav>
{% else %}
<div class="alert alert-info" role="alert">
    <i class="bi bi-info-circle me-2"></i>No existen registros en el historial.
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('filtro-boton').addEventListener('click', function () {
            document.getElementById('filtro-form').submit();
        });
    });
</script>
{% endblock %}