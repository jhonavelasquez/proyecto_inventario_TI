{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_miCuenta.css') }}">
{% endblock %}

{% block content %}
<section class="carta">
    <img src="{{ url_for('static', filename='img/fondoPerfil2.jpg') }}" alt="Fondo de la carta" class="fondoCarta">
    <img src="{{ url_for('static', filename='img/fotoPerfil.jpg') }}" alt="Foto de perfil" class="fotoPerfil">

    <div class="infoHeader">
        <div class="usuario-effect block-effect" style="--td:0.1s">
            <p class="usuario block-reveal" style="--bc: #2b3034; --d: 0.2s">{{ data['user']['nombre_usuario'] }}</p>
        </div>
        <div class="rol-effect block-effect2" style="--td:0.1s">
            <p class="rol block-reveal2" style="--bc: #2b3034; --d: 0.2s">{{ data['tipo_usuario'] }}</p>
        </div>
        <div class="rol-effect block-effect2" style="--td:0.1s">
            <p class="rol block-reveal2" style="--bc: #2b3034; --d: 0.2s">{{ data['nombre'] }}</p>
        </div>
    </div>
    <div class="info block-effect2" style="--td:0.1s">
        <p class="email block-reveal2" style="--bc: #2b3034; --d: 0.2s">
            <i class="bi bi-envelope-at" style="margin-right: 10px;"></i>{{ data['user']['email'] }}
        </p>
    </div>

    <button class="btn btn-warning botonEditar" type="button" data-bs-toggle="collapse" data-bs-target="#editarInfo"
        aria-expanded="false" aria-controls="collapseExample">
        <i class="bi bi-pencil-square" style="margin-right: 5px;"></i> Editar
    </button>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mt-3">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="collapse editarInfo" id="editarInfo">
        <h3>Actualiza tus datos</h3>
        
        <form action="{{ url_for('cuenta') }}" method="POST" id="updateForm">
            {{ form.hidden_tag() }}
            <button type="button"
                    class="btn btn-link"
                    style="display: flex; justify-content: start; width: 30px;"
                    data-bs-toggle="tooltip" data-bs-placement="right"
                    data-bs-title="Debe ingresar un correo para cambiar la contraseña">
                    <i class="bi bi-question-circle"></i>
                </button>
            <div class="form-floating mb-3">
                {{ form.email_user(class="form-control", id="email_user",
                onkeyup="javascript:this.value=this.value.toUpperCase();", placeholder="name@example.com") }}
                <label for="email_user" class="form-label">Correo Electrónico</label>
            </div>
            <button type="button"
                    class="btn btn-link"
                    style="display: flex; justify-content: start; width: 30px;"
                    data-bs-toggle="tooltip" data-bs-placement="right"
                    data-bs-title="Si desea actualizar su contraseña, ingrese una nueva. Si no desea modificar su contraseña, deje estos campos vacíos.">
                    <i class="bi bi-question-circle"></i>
                </button>
            <div class="form-floating mb-3">
                
                {{ form.psw(class="form-control", id="psw", placeholder="") }}
                <label for="psw" class="form-label">Contraseña</label>
                <button type="button" 
                    class="btn btn-light position-absolute top-50 end-0 translate-middle-y"
                    id="togglePassword"
                    style="background-color:transparent; border: none;">
                    <i class="bi bi-eye"></i>
                </button>
            </div>
            <div class="form-floating mb-3">
                {{ form.psw_confirmar(class="form-control", id="psw_confirm", placeholder="") }}
                <label for="psw_confirm" class="form-label">Confirmar Contraseña</label>
                <button type="button"
                    class="btn btn-light position-absolute top-50 end-0 translate-middle-y"
                    id="togglePassword2"
                    style="background-color:transparent; border: none;">
                    <i class="bi bi-eye"></i>
                </button>
            </div>
            <br>
            <div id="err" style="color: red; font-weight: bold;"></div>
            <button type="submit" class="button_slide slide_right">Guardar</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const togglePassword = document.getElementById('togglePassword');
            const togglePassword2 = document.getElementById('togglePassword2');
            const passwordField = document.getElementById('psw');
            const confirmPasswordField = document.getElementById('psw_confirm');
            const err = document.getElementById('err');

            togglePassword.addEventListener('click', function () {
                const type = passwordField.type === 'password' ? 'text' : 'password';
                passwordField.type = type;
                this.querySelector('i').className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
            }); 

            togglePassword2.addEventListener('click', function () {
                const type = confirmPasswordField.type === 'password' ? 'text' : 'password';
                confirmPasswordField.type = type;
                this.querySelector('i').className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
            });

            document.getElementById('updateForm').addEventListener("submit", (e) => {
                if (passwordField.value !== confirmPasswordField.value) {
                    e.preventDefault(); // Prevenir que la página se recargue
                    err.innerHTML = "Las contraseñas no coinciden"; // Notificar al usuario
                    setTimeout(() => {
                        err.innerHTML = ""; // Limpiar el mensaje después de 1.2 segundos
                    }, 1200);
                }
            });
        });
    </script>
</section>

{% endblock %}