{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_miCuenta.css') }}">
{% endblock %}

{% block content %}
<section class="carta">
    <img src="{{ url_for('static', filename='img/fondoPerfil.jpg') }}" alt="Fondo de la carta" class="fondoCarta">
    <img src="{{ url_for('static', filename='img/fotoPerfil.jpg') }}" alt="Foto de perfil" class="fotoPerfil">

    <div class="infoHeader">
        <div class="usuario-effect block-effect" style="--td:0.1s">
            <p class="usuario block-reveal" style="--bc: #2b3034; --d: 0.2s">{{ data['user']['nombre_usuario'] }}</p>
        </div>
        <div class="rol-effect block-effect2" style="--td:0.1s">
            <p class="rol block-reveal2" style="--bc: #2b3034; --d: 0.2s">{{ data['tipo_usuario'] }}</p>
        </div>
        <div class="rol-effect block-effect2" style="--td:0.1s">
            <p class="rol block-reveal2" style="--bc: #2b3034; --d: 0.2s">{{ data['nombre'] }}</p>
        </div>
    </div>
    <div class="info block-effect2" style="--td:0.1s">
        <p class="email block-reveal2" style="--bc: #2b3034; --d: 0.2s">
            <i class="bi bi-envelope-at" style="margin-right: 10px;"></i>{{ data['user']['email'] }}
        </p>
    </div>

    <button class="btn btn-warning botonEditar" type="button" data-bs-toggle="collapse" data-bs-target="#editarInfo"
        aria-expanded="false" aria-controls="collapseExample">
        <i class="bi bi-pencil-square" style="margin-right: 5px;"></i> Editar
    </button>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mt-3">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="collapse editarInfo" id="editarInfo">
        <h3 class="card-title mb-4">Actualiza tus datos</h3>
        <form action="{{ url_for('cuenta') }}" method="POST" id="updateForm">
            {{ form.hidden_tag() }}
            <div class="mb-3">
                <label for="email_user" class="form-label">Correo Electrónico</label>
                <div class="input-group">
                    {{ form.email_user(class="form-control", id="email_user",
                    onkeyup="javascript:this.value=this.value.toUpperCase();", placeholder="name@example.com") }}
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="tooltip"
                        data-bs-placement="right" title="Debe ingresar un correo para cambiar la contraseña">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </div>
            </div>
            <div class="mb-3">
                <label for="psw" class="form-label">Contraseña</label>
                <div class="input-group">
                    {{ form.psw(class="form-control", id="psw", placeholder="Nueva contraseña") }}
                    <button type="button" class="btn btn-outline-secondary" id="togglePassword">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
            </div>
            <div class="mb-3">
                <label for="psw_confirm" class="form-label">Confirmar Contraseña</label>
                <div class="input-group">
                    {{ form.psw_confirmar(class="form-control", id="psw_confirm", placeholder="Confirmar nueva contraseña") }}
                    <button type="button" class="btn btn-outline-secondary" id="togglePassword2">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
            </div>
            <div class="mb-3">
                <small class="text-muted">Si no desea modificar su contraseña, deje estos campos vacíos.</small>
            </div>
            <div id="err" class="text-danger mb-3"></div>
            <button type="submit" class="btn btn-primary w-100">Guardar Cambios</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const togglePassword = document.getElementById('togglePassword');
            const togglePassword2 = document.getElementById('togglePassword2');
            const passwordField = document.getElementById('psw');
            const confirmPasswordField = document.getElementById('psw_confirm');
            const err = document.getElementById('err');
    
            function togglePasswordVisibility(field, button) {
                const type = field.type === 'password' ? 'text' : 'password';
                field.type = type;
                button.querySelector('i').className = `bi bi-eye${type === 'password' ? '' : '-slash'}`;
            }
    
            togglePassword.addEventListener('click', () => togglePasswordVisibility(passwordField, togglePassword));
            togglePassword2.addEventListener('click', () => togglePasswordVisibility(confirmPasswordField, togglePassword2));
    
            document.getElementById('updateForm').addEventListener("submit", (e) => {
                if (passwordField.value !== confirmPasswordField.value) {
                    e.preventDefault();
                    err.textContent = "Las contraseñas no coinciden";
                    setTimeout(() => {
                        err.textContent = "";
                    }, 3000);
                }
            });
    
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });
    </script>
</section>

{% endblock %}